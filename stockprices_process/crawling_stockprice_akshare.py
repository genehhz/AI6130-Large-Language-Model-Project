# -*- coding: utf-8 -*-
"""
Created on Sun Oct 26 22:30:29 2025

@author: geneh
"""
import time
from typing import List, Optional
import pandas as pd
import akshare as ak

# ---- your inputs ----
'''
stock_list = ["000001", "000002", "000063", "000301", "000333", "000338", "000568", "000596", "000630", "000651", 
              "000661", "000708", "000768", "000776", "000786", "000792", "000800", "000807", "000876", "000895", 
              "000938", "000963", "000977", "000983", "000999", "001289", "001979", "002001", "002027", "002049", 
              "002050", "002142", "002179", "002180", "002230", "002236", "002241", "002252", "002304", "002311", 
              "002352", "002371", "002422", "002460", "002466", "002475", "002493", "002600", "002601", "002648", 
              "002714", "002916", "002920", "002938", "003816", "300014", "300015", "300033", "300059", "300274", 
              "300308", "300316", "300347", "300394", "300408", "300418", "300433", "300502", "300628", "300661", 
              "300750", "300759", "300760", "300782", "300832", "300999", "301236", "301269", "600000", "600009", 
              "600010", "600011", "600015", "600016", "600019", "600023", "600026", "600028", "600031", "600036", 
              "600039", "600050", "600061", "600085", "600089", "600104", "600115", "600150", "600160", "600161", 
              "600176", "600183", "600188", "600196", "600219", "600233", "600276", "600332", "600346", "600362", 
              "600372", "600377", "600415", "600436", "600438", "600460", "600482", "600489", "600515", "600519", 
              "600570", "600584", "600585", "600588", "600600", "600660", "600674", "600741", "600760", "600795", 
              "600809", "600845", "600887", "600893", "600900", "600905", "600918", "600919", "600938", "600941", 
              "600958", "600999", "601006", "601009", "601012", "601021", "601058", "601059", "601066", "601077", 
              "601088", "601100", "601111", "601117", "601127", "601136", "601166", "601186", "601211", "601225", 
              "601229", "601236", "601238", "601288", "601318", "601319", "601360", "601390", "601398", "601600", 
              "601601", "601607", "601618", "601628", "601658", "601668", "601669", "601698", "601728", "601766", 
              "601788", "601799", "601800", "601808", "601816", "601825", "601838", "601857", "601865", "601868", 
              "601872", "601881", "601888", "601898", "601901", "601916", "601919", "601939", "601985", "601988", 
              "601995", "603019", "603195", "603259", "603260", "603296", "603392", "603799", "603806", "603833", 
              "603986", "603993", "605117", "605499", "688008", "688036", "688041", "688082", "688111", "688126", 
              "688169", "688187", "688223", "688256", "688271", "688303", "688396", "688472", "688506", "688981"]
'''

stock_list = ["002493", "002600", "002601", "002648", 
              "002714", "002916", "002920", "002938", "003816", "300014", "300015", "300033", "300059", "300274", 
              "300308", "300316", "300347", "300394", "300408", "300418", "300433", "300502", "300628", "300661", 
              "300750", "300759", "300760", "300782", "300832", "300999", "301236", "301269", "600000", "600009", 
              "600010", "600011", "600015", "600016", "600019", "600023", "600026", "600028", "600031", "600036", 
              "600039", "600050", "600061", "600085", "600089", "600104", "600115", "600150", "600160", "600161", 
              "600176", "600183", "600188", "600196", "600219", "600233", "600276", "600332", "600346", "600362", 
              "600372", "600377", "600415", "600436", "600438", "600460", "600482", "600489", "600515", "600519", 
              "600570", "600584", "600585", "600588", "600600", "600660", "600674", "600741", "600760", "600795", 
              "600809", "600845", "600887", "600893", "600900", "600905", "600918", "600919", "600938", "600941", 
              "600958", "600999", "601006", "601009", "601012", "601021", "601058", "601059", "601066", "601077", 
              "601088", "601100", "601111", "601117", "601127", "601136", "601166", "601186", "601211", "601225", 
              "601229", "601236", "601238", "601288", "601318", "601319", "601360", "601390", "601398", "601600", 
              "601601", "601607", "601618", "601628", "601658", "601668", "601669", "601698", "601728", "601766", 
              "601788", "601799", "601800", "601808", "601816", "601825", "601838", "601857", "601865", "601868", 
              "601872", "601881", "601888", "601898", "601901", "601916", "601919", "601939", "601985", "601988", 
              "601995", "603019", "603195", "603259", "603260", "603296", "603392", "603799", "603806", "603833", 
              "603986", "603993", "605117", "605499", "688008", "688036", "688041", "688082", "688111", "688126", 
              "688169", "688187", "688223", "688256", "688271", "688303", "688396", "688472", "688506", "688981"]

START = "20230101"
END   = "20231131"
ADJUST = ""           # "", "qfq", or "hfq"
MAX_RETRIES = 1
SLEEP_BETWEEN = 20   # seconds, to be gentle

# columns you want (as AkShare usually returns them in Chinese)
KEEP_COLS = ["日期", "开盘", "收盘", "最高", "最低", "成交量", "成交额", "振幅", "涨跌幅", "涨跌额"]
OUTPUT_ORDER = ["日期", "股票代码", "开盘", "收盘", "最高", "最低", "成交量", "成交额", "振幅", "涨跌幅", "涨跌额"]

def fetch_one(code: str) -> Optional[pd.DataFrame]:
    """Fetch one symbol with simple retry/backoff; return filtered DataFrame or None."""
    for attempt in range(1, MAX_RETRIES + 1):
        try:
            df = ak.stock_zh_a_hist(
                symbol=code,
                period="daily",
                start_date=START,
                end_date=END,
                adjust=ADJUST
            )
            if df is None or df.empty:
                return None

            # keep only the needed columns that exist
            cols_present = [c for c in KEEP_COLS if c in df.columns]
            df = df[cols_present].copy()

            # add the code as a column
            df["股票代码"] = code

            # reorder (only those available)
            order_present = [c for c in OUTPUT_ORDER if c in df.columns]
            df = df[order_present]

            return df

        except Exception as e:
            if attempt == MAX_RETRIES:
                print(f"[FAIL] {code}: {e}")
                return None
            sleep_s = SLEEP_BETWEEN * attempt
            time.sleep(sleep_s)

    return None

# run
all_dfs: List[pd.DataFrame] = []
for i, code in enumerate(stock_list, 1):
    out = fetch_one(code)
    if out is not None and not out.empty:
        all_dfs.append(out)
        print(f"[{i}/{len(stock_list)}] OK {code}: {len(out)} rows")
    else:
        print(f"[{i}/{len(stock_list)}] EMPTY/FAIL {code}")
    time.sleep(SLEEP_BETWEEN)

result = pd.concat(all_dfs, ignore_index=True) if all_dfs else pd.DataFrame(columns=OUTPUT_ORDER)

# inspect “attributes”/metadata
print(result.columns)
print(result.dtypes)
result.info()

# save if you like
result.to_csv("a_share_prices_selected.csv", index=False, encoding="utf-8-sig")
# result.to_excel("a_share_prices_selected.xlsx", index=False)
print("Saved to a_share_prices_selected.csv")